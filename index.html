<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>短链接生成器</title>
<style>
body { font-family: system-ui, sans-serif; background:#0a0f1c; color:#eaf0ff; padding:2em; }
input, select, button { padding:0.5em; margin:0.3em 0; width:100%; }
.hidden { display:none; }
#result { margin-top:1em; background:#1a1f3c; padding:1em; border-radius:8px; word-break:break-all; }
button.copy-btn { margin-top:0.5em; }
</style>
</head>
<body>

<h2>生成 OTT 短链接</h2>

<label>UID:</label>
<div style="display:flex; gap:0.5em;">
  <input type="text" id="uid" placeholder="请输入 UID" />
  <button id="pasteBtn">粘贴</button>
</div>

<label>文件名 (隐藏，自动填):</label>
<input type="text" id="filename" class="hidden" value="pl.m3u">

<label>过期时间:</label>
<select id="expiry">
  <option value="month">1 个月</option>
  <option value="year">1 年</option>
  <option value="forever">永久</option>
</select>

<button id="genBtn">生成链接</button>

<div id="result" class="hidden">
  <div>短链接: <span id="shortLink"></span></div>
  <button class="copy-btn" id="copyBtn">复制链接</button>
</div>

<script>
const SIGN_SECRET = "mySuperSecretKey"; // 必须和 Worker 一致
const BASE_URL = window.location.origin;

document.getElementById("pasteBtn").addEventListener("click", async () => {
  try {
    const text = await navigator.clipboard.readText();
    document.getElementById("uid").value = text;
  } catch(e){ alert("无法读取剪贴板"); }
});

document.getElementById("genBtn").addEventListener("click", async () => {
  const uid = document.getElementById("uid").value.trim();
  const file = document.getElementById("filename").value.trim();
  if(!uid){ alert("请输入 UID"); return; }

  // 过期时间
  const now = new Date();
  let exp = now.getTime() + 8*3600*1000; // 马来西亚时间基础
  const choice = document.getElementById("expiry").value;
  if(choice==="month") exp += 30*24*3600*1000;
  else if(choice==="year") exp += 365*24*3600*1000;
  else if(choice==="forever") exp = 32503680000000; // 3000年

  // 调用 /api/create-token
  try {
    const resp = await fetch("/api/create-token", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ uid, file })
    });
    if(!resp.ok) throw new Error("请求失败");
    const data = await resp.json();
    const code = data.code;

    // 生成签名
    const sig = await generateHmac(uid + ":" + exp, SIGN_SECRET);

    const link = `${BASE_URL}/id${code}?uid=${encodeURIComponent(uid)}&exp=${exp}&sig=${sig}`;
    document.getElementById("shortLink").textContent = link;
    document.getElementById("result").classList.remove("hidden");

  } catch(e){
    alert("生成失败：" + e.message);
  }
});

// 复制
document.getElementById("copyBtn").addEventListener("click", async () => {
  const link = document.getElementById("shortLink").textContent;
  try { await navigator.clipboard.writeText(link); alert("已复制！"); } 
  catch(e){ alert("复制失败"); }
});

// HMAC-SHA256 生成签名
async function generateHmac(message, secret){
  const key = await crypto.subtle.importKey(
    "raw", new TextEncoder().encode(secret), { name:"HMAC", hash:"SHA-256" }, false, ["sign"]
  );
  const sig = await crypto.subtle.sign("HMAC", key, new TextEncoder().encode(message));
  return Array.from(new Uint8Array(sig)).map(b=>b.toString(16).padStart(2,"0")).join("");
}
</script>

</body>
</html>
