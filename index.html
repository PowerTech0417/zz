<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Token ç®¡ç†åå°</title>
<style>
  body { font-family: system-ui, sans-serif; background:#0a0f1c; color:#eaf0ff; padding:2em; }
  input, button, select { font-size:1em; margin:0.2em 0; padding:0.5em; }
  button { cursor:pointer; }
  .hidden { display:none; }
</style>
</head>
<body>
<h1>Token ç®¡ç†åå°</h1>

<label>UID: 
  <input type="text" id="uidInput" placeholder="è¾“å…¥ UID">
  <button id="pasteBtn">ğŸ“‹ ç²˜è´´</button>
</label>
<br>

<!-- æ–‡ä»¶åéšè— -->
<input type="text" id="fileInput" class="hidden" value="pl.m3u">

<label>è¿‡æœŸæ—¶é—´: 
  <select id="expirySelect">
    <option value="1m">1 ä¸ªæœˆ</option>
    <option value="1y">1 å¹´</option>
    <option value="perm">æ°¸ä¹…</option>
  </select>
</label>
<br>

<button id="createTokenBtn">ç”ŸæˆçŸ­é“¾æ¥</button>
<br><br>

<label>ç”Ÿæˆçš„é“¾æ¥: </label>
<input type="text" id="shortLink" readonly>
<button id="copyLinkBtn">å¤åˆ¶é“¾æ¥</button>

<script>
const uidInput = document.getElementById("uidInput");
const pasteBtn = document.getElementById("pasteBtn");
const createTokenBtn = document.getElementById("createTokenBtn");
const shortLink = document.getElementById("shortLink");
const copyLinkBtn = document.getElementById("copyLinkBtn");
const fileInput = document.getElementById("fileInput");
const expirySelect = document.getElementById("expirySelect");

// ç²˜è´´å‰ªè´´æ¿å†…å®¹åˆ° UID
pasteBtn.addEventListener("click", async () => {
  try {
    const text = await navigator.clipboard.readText();
    uidInput.value = text;
  } catch (e) {
    alert("æ— æ³•è¯»å–å‰ªè´´æ¿: " + e);
  }
});

// ç”ŸæˆçŸ­é“¾æ¥
createTokenBtn.addEventListener("click", async () => {
  const uid = uidInput.value.trim();
  const file = fileInput.value;
  const expiryOption = expirySelect.value;

  if (!uid) {
    alert("è¯·è¾“å…¥ UID");
    return;
  }

  // è®¡ç®—è¿‡æœŸæ—¶é—´ï¼ˆé©¬æ¥è¥¿äºšæ—¶é—´ UTC+8ï¼‰
  const now = Date.now() + 8*60*60*1000;
  let exp;
  if (expiryOption === "1m") {
    exp = now + 30*24*60*60*1000; // 30å¤©
  } else if (expiryOption === "1y") {
    exp = now + 365*24*60*60*1000; // 365å¤©
  } else {
    exp = now + 100*365*24*60*60*1000; // æ°¸ä¹…ï¼Œå¤§çº¦100å¹´
  }

  try {
    const resp = await fetch("/api/create-token", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ uid, file, exp })
    });
    if (!resp.ok) throw new Error(resp.statusText);
    const data = await resp.json();
    const code = data.code;
    shortLink.value = `m.pwbtw.workers.dev/id${code}`;
  } catch (e) {
    alert("ç”Ÿæˆå¤±è´¥: " + e);
  }
});

// å¤åˆ¶çŸ­é“¾æ¥
copyLinkBtn.addEventListener("click", async () => {
  const link = shortLink.value;
  if (!link) return;
  try {
    await navigator.clipboard.writeText(link);
    alert("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
  } catch (e) {
    alert("å¤åˆ¶å¤±è´¥: " + e);
  }
});
</script>
</body>
</html>
